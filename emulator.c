#include <allegro5/allegro.h>
#include <allegro5/allegro_primitives.h>
#include <allegro5/allegro_font.h>
#include <stdarg.h>
#include <math.h>
#include "emulator.h"
#include "celeste.h"
#include "lemon.h"

//game data
static ALLEGRO_BITMAP* atlas = NULL;
static ALLEGRO_BITMAP* sprites[256] = {NULL};
static ALLEGRO_COLOR base_palette[16] = {
	#define RGB(r,g,b) (ALLEGRO_COLOR){(float)r/255.0,(float)g/255.0,(float)b/255.0, 255.0}
	RGB(0x00, 0x00, 0x00),
	RGB(0x1d, 0x2b, 0x53),
	RGB(0x7e, 0x25, 0x53),
	RGB(0x00, 0x87, 0x51),
	RGB(0xab, 0x52, 0x36),
	RGB(0x5f, 0x57, 0x4f),
	RGB(0xc2, 0xc3, 0xc7),
	RGB(0xff, 0xf1, 0xe8),
	RGB(0xff, 0x00, 0x4d),
	RGB(0xff, 0xa3, 0x00),
	RGB(0xff, 0xec, 0x27),
	RGB(0x00, 0xe4, 0x36),
	RGB(0x29, 0xad, 0xff),
	RGB(0x83, 0x76, 0x9c),
	RGB(0xff, 0x77, 0xa8),
	RGB(0xff, 0xcc, 0xaa)
	#undef RGB
};
static ALLEGRO_COLOR palette[16];

#define tilemap_length 8192
//static unsigned char tilemap[tilemap_length] = "#1%%H%%222223\0\0$%&$%%&1222%&((($%%%%%%23(8((1%%%22223\0\0\01222222223\0\0\0$22231222%%%%%H%%%%%%%&(($%%H%%%&(((($%H%%%&((((1222%H%%%%%%#12223)\0\0()\0\0\0$%&1223((\0($&*\x10($%H%%%&\0*(()(\x10$H%((()\0\0\0\0(()\0\0\0\0\0(\x10\0\0\07()\0\0\0\0*(1H%%%%%H%%2223(($%%%H%238(*(12%%H%&(8(((**(12222%%%%# \x10(8\0\0\0*\0\0\0=$%%# \x10())\0($&\0:8$%%%H%3\0\0)\0\0*\01%%(8)\0\0:gh8(\0\0\0\0\0\08(9>\0:(\0\0\0\0\0\0(\0$%%222223!\"\"#(($%%%23((()\0\0*(12%%&(((()\0\0*(((8($H223((()\0\0\0\0\0?  $H%&(()\0\0\0*$3\0\0*$%2%%&\0\0\0\0\0\0\0\0\01%)\0\0\0\0!\"#((\0\0\0\0\0\0*((456)\0\0\0\0\0\0(9$%&!\"# !#1223(($%H&+\0\0\0\0\0\0\0\x1c\0\0;$%&(((\0\0\0\0\0((((($%#@(8():(9\0\0\045\"%%H&)\0\0\0\0\0\00\0\0\0\0$3\01%3=?\0\0\0\0\0\0\0\01\0\0\x1c::1%& (9\0\0\0\0\0\0\x10((()\0\0\0\0\x11\x11:((123$%&\x10\x31\x33 ((((8$%%&+\0\0\0\0\0\0\0\0\0\0;$%&*((g\0\x16\0*((8(($%&:(((\x10()\0\0\0\0\0\01%%23\0\0\0\0\x11\0\07\0\0\0>$\0\0\07!\"#\0\0\0\0\0\0\0\0\09Xh((($&()\0\0\0\0\0\0*(()\0\0\0\0\0\0!#(8()((123(()\0*\0*(($%%3+\xc\0\0\0\x11\x11\0\0\0\xc;1H&\x11(\x10\0\0\0\0h((((($%%\"556((\0\0\0\0\0\0:($&\0=\0:9\0'\0\0\0\0\0\0!%\0\x1a\0\0$%&\x11\x11\x11\x11\0\0\0\0,(8(((813(\0\0\0\x17\x17\0\0\0*\0\0\0\0\x11\x11\0\0$&\x10()\0((\x1b\x1b\x1b((\0\0\0\0\0*!%H&(9\0\0\0;46+\0\0\0\0($%#((:g\0:((()\0*12%38(()\0\0\0\0\0\0\0(8$%#  \x10)\009\0\0\0\0X$H\0\0\0:1225556gX\0\0<((((\x10(!#)\0\0\0\0\0\0\0\0\0\0\0\0\046\0:$&((\0\08(9\0\0\0*)\0\0\0\0\0122&\x10\x10\0\0\0\0((9\0\0\0\0*$%3(((8\0(((9\0\0\0\x17\0&\0\0*(\0\0\0\0:(:((($%%\"#(9\07(X9\0h(12\0\0\0(((((  (((9!\"()\0*(($&\0\0\0\0\0\0\0\0\0\0\0\0\0\0 8((1%#\0\0\0((()\0\0\0\0\0\x16:gh((\038(\xb\0\0\0\x10\x38(\0\0\xb\0\013(((((h((((\0\0\0\x17\03\0\0\0(gX\0\0(\x10((4\"%%%H&((g (((8((!\"\0\0:(8(\x10)\0\0*(8($%*\0\0\0(8$&\0\0\0\x17\x17\0\0\0\0\0\0\0\0\0'((*(139\0\0()\0\0\0\0\0\0\0\0*((()\0*(9\0\0\0\0*()\0\0\0\0\0\0(((8(((((()\0\0\0\0\0\0\0\0:((8>:(((8($%H%%&\0*(')\0*((42%\0\0\0*(((\0\0\0\0(\x10($%\0\0\0\0*($&\0\0\0\0\0\0\0\0\0\0\0\0\0\07(\0\0\0*((9\0(\0\0\09(9\0\0\0\0\0((\0\0\0()\0\0\0*((\0\0\0\0\0\0\0*((((\x10((((gX\0\0\0\0\0\0\0(8((!#(\0\0*($%22%&\0:(0\0\0\0\0*(($\0\0\0\0\0*(\x11\x11\x11\x11((($H\0\0\0:((13\0\0\0\0\0\0\x17\x17\0\x1?\0\0\0 )\0\0\0\08(\0\0(\x1:((\x10(X\0\0\0:()\0\0\0*(\xc\0\0\0:8\xc\0\0\0\0\0\xc\0\0*((((()(()\0\0\0:\0\x1:!#(*13)\0\x11\x11\x11$%\0(1&:8)0\0\0\0\0\0\0*1\0\0\0\0\0\0(4\"\"6)*\0$%>\x1:8()*\0\0\0\0\0\0\0\0\05556\0\0 \0\0\0\0=*(g\x14\"\"#(((((9\0X(8(=\0\0:)\0\0\0\0((\0\0\0\0\0\0\0\0\0*((*)\0\0X\x10\0\x12\0*(\"\"\"%&)\0!#\x11\x11!\"\"%%\0*87()\00\x11\x11\x11\0\0\0:(\0\x1?\0\0\0*($&)\0\0\0$%\"\"\"#)\0\0\0\0\0\0\0\x17\x17\0\0*( 9\0: \0\0:\045555%%%\"\"\"#((((\x10((!\"\xb\x10\0\0\0\0\xb(\x10\0\0\0\xb\0\0\0,\0\0(8\0\0\0\0*(9\x17\0\0(%H%%&\x11\x11$%\"\"%%%H%\0\x1*((g?$\"\"#\0\0\08(\"\"#\0\0\x12\0*$&\0\0\0\x12$%%%%&\0\0\0\0\x17\x17\0\0\0\0\0\0\08 (9('\x8\0(gh (((%H%%%%&*((!\"\"\"%%:(\x1=\0\0\0h(9\0\0\0\0\0\0<\x1h((\0\x17\x17\x17\0:(\0\0:(%%%%%\"\"%%%%%%%%%\"\"\"\"\"\"\"%%H&gXh((%H&\0\0'\0\0$&\0\0\0!%%%%H&\x17\x17\0\0\0\0\0\0\0\0\0\0\0* (\x10(0\0:((( (((%%%%H%&\0\0*$%%%H%(!\"#\0\0\0(((\0\0\0\0\0\0\"\"\"#(g\0\0\0\0((9\0(8%23\0\0\0$2222222%%%%&(((($%2222%H%%2222222%&((($H%%%%3\0\0\0\0\0\0\0\0\0\0\0R%%22223122223()\0&()(g\0\0\0\0\0((1222%%%23((\01%%H%%%H%%H&(8(1222222%H&((\0\0\00@*((((($%%H&(8((138()\012%&(\0\0\x16:((13((8$%%H%&\0\0\0\0\0\0\0\0\0\0\0\0R%&\0\0\x16\0\0\0\0*\x10((89\0&(\x1a\x38 9=\0\0\0\0*8(((%%&((()\0;$%222222223((((((\x10(( 1%3(9\0\0\07\0\0*8(\0*$%%%&(((( ()*\0\0\0*13(\x11\x11\x11(((\0\0(\0*1%%%%&\0\0\0\0\0\0\0\0\0\0\0\0R%&\0\0\0\0\x11\x11\0\0\0)*()\0&(:( \x10 \x11\x11\x11!\"#((\x10%%&(8(\0\0;$&+\0**8((((()\0*(\0((8((1((\x10)\0\0\0\0\0\0((9\0$H%%&()\0( g\0\0\0\0\0\0\08\x10!\"#(8)\0:\x10)\0*$%223g\0\0\0\0\0\0\0\0\0\0B\0%&9\0\0\0!#\0\0\0\0\0!\"\"%\"\"#!\"#!\"#$H&(((223(((\0\0;13+\0\0\0(\x10()\0\0\0\0\0)\0*((()\0(((\0\x16\0\0\0\x16*(((\0$%%%&'\0\0* )\0\0\0\0\0\0\0(4%%3)*\0\0\0*\0\x11\x11$%\"#((\0\0,FG,\0\0\0BSS%&(\0\0:$&\0\0\x16\0\0$%%%%H&123123$%& (8\"\"#()(g\0\0()\0\0\0\0\0(8\0\x11\x11\0\0\x12\0\0\0()*\x16\0(8(\0\0\0\0\0\0\0:()\0$%H%&7\0\0\0)\0\0\0\0\0\0\0:);$&(9\0\0\0\0\0;!\"%%%&8(g\0<VW<BCCScc23(9\0($&\x11\x11\x11\x11\x11$%%%H%& \x1b\x1b\x1b\x1b\x1b$%&(((%%&\0\0*(\x14:)\0\0\0\0\0\0();!#\0\0\x17\0\0\x11(g\0\0\0(((gX\0\0\0Xh(8\0\012223 \0\0\0\0\0\0\0\0\0'((\0;$&)\0\0\0\0\0\0;1%H%%3(((9!\"\"#RSSd\0\0)\0*(8(125555\"%H%%%%%#\0\0\0\0\0123(\x10(H%&\x11\x11\x11\x34\x35\x36\x11\x11\x11\x11\0\0\0\0\0;13\x11\x11\x11\x11\x11'()\0\0;((((\x10)\0\0\0*((g\0\0(5556\x11\x11\0\0\0\0\0\0\x11\x30(8\0;13\0\0\0\0\0\0\0*(12%&*((\x10($%%&bcd\0\0\0\0\x16\0((()\0\0\0\0\012%%%%%%&gX\0\0\0 \0\0*((%%2555\"\"\"\"\"569\0\0\0\0;455555608\0\0\0\x17()\0\0*\0\0\0\0\08*)\0:((((46 \0\0\0\0\0\0 0((\0\0*)\0\0\x11\x11\0\0\0\0(((1&\0)\0*($H%%#\0\0\0\0\09\0:()\0\0\0\0\0\0\0\0(12%%H%&8)\0\0\0\x17\0\0Xh(23\x10();$H%%&(((\0\0\0\0; \x1b\x1b\x1b\x1b\x1b\x1b\x30(\0\0\0\x17(:\0\0\0\0\0\0\0\0(\0\0\0(((8\x10)*\0\0\0\0\0\0\0*7\x10(\x11\x11\x11\x11\x11\x11!6\0\0\0\0*(8\xb&\0\0\0\0!%%%%&\0\x1c\0\0\0(((\x10\0\0\0\0\0\x11\0\0*8()%%%%&(\0\0\0\0\x17\0\0*!\"(()\x8\0;$%%H&(()\x12\0\0\0\0\x1b\0\0\0\0\0\00)\0\0\0;8)\0\0\0\0\0\0\0:\x10)\0\0(8(((\0\0\0\0\0\0\0\0\0\0*((\"555553\0\0\0\0\0\0((93\0\0\0\012%%%3\0\0\0\0\0(8()\0\0\0\0; +\0h((\022223)\0\0\0\0\0\0\0\01%((\0\0\0;122%&8(\0\x17\0\0\0\0\0\0\0\0\x11\0\07\0\0\0\0\0)\0\0\0\0\0\0\0\0\0*\0\0\0()()*\0\0\0\0\0\0\0\0\0\0\0(*3(8(()\0\0\0\0\0\0\0\x10((\0\0\0\0BCD$%&(9\0\0\0\0(\0*\0\0\x11\0\0\0\x1b\0* \x10),\x1b\x1b\x1b\x1b\0\0\0\0\0\0\0\0\0\0\x10\x31()\x16\0\0\0\x1b\x1b\x1b\x31\x33(\x10g\0\0\0\0\0\x11\0\0:'\0\0\x1b\0\0\0\0\0\0\0\x1\0\0\0\x11\x11\x11\0\0\0\0\0*:*\0\0\0\0\0\0\0\0\0\0\0\0*(\0(()\0*\0\0\0\0\0\0\0\0(((\0\0\0\0RST$H&((\0\0\0\0)\0\0\0; +9\0\0\0\0)\0\0<\0\0\0\0\0\0\0\0\0\0\0\0\0\0(((\0\0\0\0\0\0\0\0\x1b\x1b*()\0\0\x1\0\0'9\080\0\0\0\0\0\0\0\0\x11\x11 \x11\x11\x11!\"#\0\0\0\x12\x12\0*\0\x1\0\0\0\0\0\0\0\0\0\0\0\0)\0)\0\0\0\0\0\0\0\0\0*gh()\0\0?\x1\0RST$%&(\x10g:9\0\x1?\0\0\0*8)\0\x11\0\0\0\0\0!\x1\0\0\0\0\0\0\0:g\0\0\0\0*8(gXh\0\0\x1\0\0\0\0h(\0\0\0!#\07()(0\0\0\0\0\0\0\0\0\"\"\"\"\"#$H&\x11\x11\x11  \x11\x11\0'9\0\0\x17\x17\0\0\0\x17\x17\0\0\0\0\0\x1\0\0\0\0\x17\x17\0\0\0((89:\0!\"#RST$%3(((8)\0\"#+\0\0\x8(9;'\0\0\0\0\x14$#\0\0\0\x12\0\0\0()\0\0\0\0\0(((\x10(g\0\x17\x17\x17\x17\x17((9\0\0139'\x10\x12(7\0\0\0\0\0\0\0\0%H%%%&$%&!\"\"\"\"\"\":08\0\0\0\0\0\0\0\0\0\0\0\0\0\0\x17\x17\0\0\0\0\0\0\0:(((((\0$%&RST$&((((((9%&+\0\0:(\x10;0\0\0\0!\"%&\0\0\0'\0\0:(\0\0\0\0\0\0((8(((9\0\0\0Xh(8(\0\0\"#80(\x17('\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\x82\x42RRRR\x84R3\x92\0\0\x13###R#####R#\0\0\0\0\0\0\0\0\xb3\x2\0\0\x13##RRb\0\xa2\x82\x83\x42RR#######\0\0\0\0\0\0\0\xa2\x1\x82\x92\0\x13##R666F%555EU\0\0\0U%5R\x84RRb\xb2\0\0\0\0\0\0BRRRb\x82\x82\x82\x42R\x84RRR\x84RRRRR\0\0\0\0\0\0\x85\x86\x82\x42\x84RRRRR\xb1\0a\0\xb1\xb1\xb1\xb1\x3\xb1\xb1\xb1\xb1\xb1\x3\xb1\0\0\0\0\0\0\0\x11\x11\x2\0\0\0\xa2\x82\x42R3\0\0\0\xa2\x13#3\0\0\x92\0\0\x83\x92\0\0\0\0\0\0\x11\0\0\xa2\0\0\0\xa2\x82\x13\0\0\0\0&666FU\0\0\0U%5RRR\x84\x62\xb2\xa3\0\0\0\0\0BR\x84Rb\x82\x83\x82\x13#######RR\x84R\0\0\0\0\0\0\xa2\x1\x82\x13#RR\x84RR\0\0\0\0\0\0\0\0s\0\0\0\0\0s\0\0\0\0\0\0\0\xb3\x43Sc\0A\0\0\x1\x13\x62\xb2\0\0\0\0\0\0\0\0\0\0\0\0\xa2\0\0\0\0\0\0\xb3\x2\xb2\0!\0\0\0\0\xa2\x82\0\0\0\0\0\0\0\0\0V\0\0\0U&6RRR#3\xb2\x82\x92\0\x11\x11\x2\x42RRRb\x1\x92\0\x82\x92\0\0\0\0\xa2\x82\x13RRR\0\0\0\0\0\0\0\0\xa2\x82\x82\x42RRR\x84\0\0\0\0\0\0\0\0\xb1\0\0\0\0\0\xb1\0\0\0\0\0\0\0\0\0\xb3\x43Sc\x93\0\0\xb1\x62'777777777G\x11\0\0a\0\0\0\x11\0\0\xb1\0\xb3\x2\xb2\0\0\0a\x82\0\0\0\0\0\0\0\0\0\0\0\0\0V\0\0RR3\x82\x82\x82\x82\x1\xa3\x12\"\"RRRRb\x82\0\0\xa2\0\x11\x11\x11\0\0\x82\x83\x42RR\0\0\0\0\0\0\0\x93\xa3\x82\x82\x42RRRR\0\0a\0\0\x11\0\0\0\0\0\x11\0\0\0\0\x11\0\0\0\0\0\0\0\0\0\0\x2\x1\x82\0\x11R\"\"\"\"\"\"\"\"\"\"\"2\xb2\0\0\0\0\xb3\x2\xb2\0\0\0\0\xb1\0\0\0\0\0\xa2\0\0\0\0\0\0\0\0\x93\0\0\0\0\0\0\0\x84\x62\x82\x82\x82\x83\x82\x82\x82\x13##R\x84RRb\x92\0\0\0\x11$4D\0\0\xa2\x82\x42R\x84\0\0\0\0\0\0\0\xa2\x82\x83\x82\x42\x84RRR\0\0\0\0\xb3\x2\xb2\x93\x61\0\xb3\x2\xb2\0a\0r\x93\xa3\0\0\0\0\0\0\0\0\xb1\xa2\x82\x93\x12R\x84RRRRR#####b\xb2\0\0\0\0\0\xb1\0\0\0\x11\0\0\0\0\0\0\0\0\0\0\0\0\x93\0\0\x86\x82\0\0\xa3\0\0\0\0Rb\x82\x82\x1\xa2\0\xa2\x82\x82\x92\0\x13###b\x11\x11\x11\x11$55E\0\0\xb3\x12RRR\0\0\0\0\0\0\0\0\x82\x82\x82\x13####\x82\0\0\xa3\0\xb1\xa3\x82\x93\0\0\xb1\0\0\0\0s\x82\x83\x93\x11\0\0\0\0\0\0\x11\xa3\x82\x82\x13####R\x84\x62\x82\x92\0\xa2\x1s\xb2\0a\0\0\0\0\0\0\xb3\x2\xb2\0\0a\0\0\0\0\0\0\xa3\x85\x82\x82\x86\x82\x82\x82\x82\x82\x93\0\0\0Rb\x83\x82\x92\0\0\0\0\xa2\0\0\0\0\0\0R\"\"\"2&66F\0\0\xb3\x42RRR\0\0\0\x11\x11\x11\x11\xa3\x82\x82\x1\xb1\xb1\xb1\xb1\xb1\x82\x93\x82\x82\x93\0\x82\x82\0\0\0\0\0\0\0\0\xb1\0\xa2\x82r\x11\0\0\0\0\xb3r\x82\x82\x83\xb1\"\"\"2\x13#3a\0\0\x86\x92\0\0\0\0\0\x10\0\0\0\0\0\xb1\0\0\0\0\0\0\0\0\x86\x93\x82\x82\x82\x82\x1\x92\0\0\xa2\x1\x82\xa3v\x86Rb\x82\x82\x93\0\0\0\0\0\0\0\0\0\0\0RR\x84RR2\x82\x83\x92\0\0\xb3\x42\x84RR\0\0\x86\x12\"\"2\x82\x83\x82\x82\x93\0\0\0\0\x82\x82\x82\x82\x82\x83\x82\x92\0\0\0\0\0\0a\0\x11\0\xa3\x82sr\0\0\0\0\xb3s\xa2\x82\x92\x11RR\x84\x62\x83\x82\xa2\0\0\0\xa2\0\0\0\0\0\0\x2\x11\x11\x11\x11\x11\x11\x11\x11\x11\x11\x11\x11\0a\x82\x82\x82\xa2\x83\x82\x82\0\0\0\0\0\x82\x82\x82\x82Rb\x82\x92\0\0\0\0\0\0\0\0\0\0\0\0RRRRRb\x1\xa2\0\0\0\xb3\x42RRR\0\0\x1\x13#RR\"SSSc\0\0\0\0\x82\x83\0\xa2\x82\x82\x82\x1\x93\x93\0\0\x11\0\0\0r\x82\x82\x92\xb1\x3\x93\0\0\0\0\xb1\0\xa2\x82\x12R#Rb\x92\0\0\0\0\0\0\xa3\0\0\0\0\0CSSSSSSSSSSSc\xb2\0\x82\x82\x92\0\x82\x82\x92\0\x6\x16\0\xa3\x82\x83\x82\xa2\x84\x62\0\0\0\0\0\0\0\0\0\0\0\0\0\0R\x84RRRb\x92\0\0\x11\x11\x11\x42RRR\0\0\xa2\x82\x82\x13#b\xb1\xb1\xb1\xb1\0\0\0\0\x92\0\0\0\0\xa2\x82\x82\x82\x82\x93\xb3r\xb2\0\0s\x82\x1\0\x11\x3\x82\xa3\0\0\0\x11\0\x82\x82\x13\x62\x10\x13\x33\x61\0\0\0\0\0\0\x82\x93\0\0\0\0\x2\x82\x83\x82\x82\x82\x2\x82\x82\x82\x82\x82r\xb2\0\x83\x82\0\0\xa2\x82\xd3\0\x7\x17\xf3\x82\x82\x92\0\0Rb\0\0\0\0\0\0\x93\0\0\0\0\0\0\0RRRR\x84\x62\0\0\xb3\x12\"2\x13R\x84R\0\0\0\x82\x83\x92\xb3\x3\0\0\0\0\0!\0\0\0\0\0\0\0\0\0\x82\x82\x82\x82\xb3\x3\xb2\0\0\xb1\xa2\x82\x83r\x3\x82\x1\x93\0\0r\xa3\x82\x92\xb1\x62q\0\0\0\0\0\0\x93\0\0\x83\x82\0\0\0\0\xb1\xa2\x82\x82\x1\x82\xb1\xa2\x82\x83\xa2\x82s\xb2\0\x82\x82\x93\0\0\x82\x12\"2\x12\"2\x82\0\0\xa3#3\0\0\0\0\0\0\x82\x92\0\0\0\0\0\0#####3\0\0\xb3\x42RR2\x13RR\0\0\0\xa2\x82\0\xb3s\0\0\0\0\xa3r\0\0\0\x10\0\0\0\x11\x11\x11\x11\x82\x83\xb3s\xb2\0\xa3\0\0\x82\x82s\x3\x92\0\x82\x83\0s\x82\x83\0\x11\x62\x93\0\0\0\0\0\0\x82\0\0\x82\x82\x92\0\0\0\0\0\x92\x61\xa2\x82\0\0\x82\x61\0\x82\x82\0\0\x1\x92\0\0\0\x2\x13#3B\x84\x62\x82$44\0\0\0\0\0\0\0\0\x82\0\0\x85\x86\0\0\0\x83\x82\x82\x92\0\0\0\0\xb3\x42R\x84R2\x13#\0\0\x10\0\x82\0\0\x82\0\0\0\xa2\x82\x3\0\0\"\"2\x11\x11\x12SSc\x1\x82\x82\x92\0\0\x83\0\0\x92\0\xb1\x3\0\0\xa2\x82\0\0\x82\x82\0\x12\x62\x82\x92\0\0\0\0\xa3\x82\x92\0\x82\x82\0\0\0\0\x85\x86\0\0\x82\x82\xa3\x82\x82\x93\0\x82\x92\x61\0\x82\0\x10\0\0\x12\"\"\"RRR2%55\0\0\0\xf3\x10\0\0\xa3\x82\0\0\xa2\x1\0\0\0\x82\x92\0\0\0\0\x93\0\xb3\x42RRRR\"\"\x4\0\x12\"2\xb2\0\x83\x93!\0\x86\x83\x3\x93\0R\x84R\"\"b\xc0\0\xa2\x82\x82\x82\0\0\xa3\x82\x10\0\0\0\xa3s\x80\0\0\x82\x93\0\x82\x92\0\x13\x62\x82\0\0\0\0\0\x82\x83\0\xa3\x82\x1\0\0\0\0\xa2\x82\x82\x82\x92\xa2\x82\x82\x83\x82\x82\x82\0\0\04444DBR\x84RRRRb%55\0\0\0\x12\x63\0\0\x83\x82\x93\0\0\x82\0\xc1\0\x82\x10\xd3\xe3\0\xa3\x82\0\xb3\x42RRR\x84RR\x12\x32\x42Rb\xb2\x86\x82\x82r\x82\x82\x1\x3\x82\0RRRR\x84\x62\0\0\0\x82\x82\x92\0\0\x82\x82\x32\0\0\0\x83\x82\x93\0\0\xa2\x82\x1\x82\0\0\xb1\x62\x83\x93\0\0\0\0\x82\x82\0\x82\x82\x82\x93\0\0\0\0\0\x83\x82\0\0\0\xa2\x82\x1\x82\0\0\0\05555EBRRRRR\x84\x62%55\0\0\0\x3$D\0\x82\x82\x82\0\0\x82\x93\0\0\"\"\"2\x1\x82\x83\x93\xb3\x42RRRRRRRRRRRb\xb2\xb1\xb1\xb1\x13##Rb\0\x84R######RR###3\x82\x82RRRRRRRRRR\x84R#3\xb2\x82#####Rb\x82\x82\0\0\xb3\x42RRRR\x84RRRRR\x84\x84RRRb\x83\x82\x42R\x84RR#3\x82\x82\x92\x42R###RR\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0RRR\x84Rb\xb2\0\0\0\xb1\xb1\xb1\x42\x62\0#3\x82v\0\0\0\x82\x42\x33\xb2\xa2\x82\x1\x82\x83RRR\x84RR####Rb\xb1\xb1\0\x83\x92\x10\0\xa3\x82\x42\x62\x83\x92\0\0\xb3\x42##############Rb\x1\x82\x13RR#3\xb1\xb1\x1\x82\x41\x13\x33\x83\x82\x82\x42\x84\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0RRRRRb\xb2\0\0\0\0\0\xa2\x42\x62v\x82\x82\x83\x92\0\0\x11\xa2s\xb2\0\xa3\x82r\x92\0RRRRR3\xb1\xb1\xb1\xb1\x13\x33\0\0\0\x82SSSc\x82\x42\x62\x82\x41\0\0\xb3\x3\x82\xa2\xa2\xa1\x82\x92\0\xa2\x82\x83\x82\x82\x1\x82\x42\x62\0\xa2\x83Rb\xb1\xb1\0\0\x83\x12\x32\xb2\0\0\x80\x1\x42R\0\0\0\0\0\0\xa3\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0R\x84R##3\xb2\0\0\0\x11\0\x82\x42\x62\x92\x82\x1\xa2\0\0\xb3r\0\x92\0\0\0\x83\x3\0\0##RRb\xb2\0\0\0\0\xb3r\0\0\xa3\x82\x82\x82\x83\x82\x82\x42R\"2\xb2\0\xb3s\x92\x80\0\0\x1\0\x11\0\x92\xa2\x82\x92\x11\xa2\x13\x33\0\xa3\x82Rb\xb2\0\0\0\xa2\x13\x33\xb2\0\0\x86\x82\x42R\0\0\0\0\0\0\x1\0\0\x93\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0RRb\x12\"2\xb2\0\xa3vr\xb2\xa2\x42\x62\x83\x82\x92\0\0\0\xb3\x3\0\0\0\0\xa3\x82\x3\0\0\"2\x13#3\xb2\0\0\0\0\xb3\x3\x82\x93\0\xa2\x83\x82\x92\x1\x92\x42\x84Rb\xb2\0\0\0\0\0\0\0\xa2\xb3\x2\xb2\xa3\x61\x82\xb3\x2\xb2\0\x11\0\0\x82Rb\xb2\0\0\0\0\xb1\xb1\0\0\xa2\x83\xa2\x42R\0\0\0\0\xa3\0\x82\0\0\x83\0\0\0\0\0\0\0\0\0\0\0\x94\xa4\xb4\xc4\xd4\xe4\xf4\0\0\0\0RRbB\x84\x62\xb2\0\xa2\x83\x3\xb2!Bb\x92\x83\0\0\0\0\xb3\x3\0\0\0\0\0\xa2\x3\xe3\x41RR\"\"2\xb2\0\0\0\0\xb3\x3\x92\0\0\0\x82\x92\0\0\0BRRb\xb2\0\0\0\0\0\0\0\0\0\xb1\0\xa2\x82\x82\0\xb1\0\xb3\x2\xb2\x11\xa2Rb\xb2\0\0\0\0\0\0\0\0\0\x92\xb3\x42\x84\0\0\0\0\x82v\x82\0\0\x1\0\x93\0\0\0\0\0\0\0\0\0\x95\xa5\xb5\xc5\xd5\xe5\xf5\0\0\0\0##3\x13#b\xb2!\0\x82\x3\xb2q\x13\x33\0\x82\x93\x85\x86\x93\xb3\x3\x11\x11\x11\x11\x11\x11\x42\"\"RR\x84Rb\xb2\0\0\x11\0\xb3\x3\xb2\0\0\0\x82\x11\x11\x11\x11\x42R\x84\x62\xb2\0\0\0\0\0\0\0\0\0\0\0\0\x11\x1v\x85\x11\0\xb1\xb3\x2\x61\x84\x62\x11\x11\x11\x11\0\0\0a\0\0\0\xb3\x13R\0\0\0\0\x82\x83\x82g\0\x82v\x82\0\0\0\0\0\0\0\0\0\x96\xa6\xb6\xc6\xd6\xe6\xf6\0\0\0\0\x82\0\0\0\xa2\x3\x11r\0\xa2\x3\xb2\0\x1\x1\x93\x82\x82\x83\x82\x43S#SSSSSSRR\x84RRRRb\xb2\0\xb3r\0\xb3\x3\xb2\0\0\0\x82\x43SSS##Rb\xb2\0\0\x11\0\0\0\0\0\0\0\0\xb3\x2\x82\x82\x83r\xb2\x61\0\xb1\0RR2\x12\"2\xb2\0\0\0\0\0\0\0\xb1\x42\0\0\0\0\xa2\x82\x82\x12\x32\x82\x83\x92\0\0\0\0\0\0\0\0\0\x97\xa7\xb7\xc7\xd7\xe7\xf7\0\0\0\0\x92\0\x11\0\0\x13Sb\xb2\0\x13SSSSS\x92\0\xa2\0\0\x1\x82\x82\x82\x82\x92\0\xb3\x42RR####b\xb2\x61\xb3\x3\0\xb3\x3\0\0\0\0\x92\xb1\xb1\xb1\xb1\xb1\xb3\x42\x62\xb2\0\xb3r\xb2\0\0\0\x11\0\0\0\0\xb1\xa2\x82\x82s\xb2\0\0\0\0##3\x13#3\xb2\0\0\x11\x11\0\0\0\xb3\x42\0\0\0\x86\x83\x82\x12RR2\x82\x93\xa3\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\xb3r\xb2\0\xa2\x83\x3\xb2\0\0\0\xa2\x82\x93\xb3\0\0\0\0\0\0\xa2\x82\x83\x82\x82v\x12RRR\xb1\xb1\xb1\xb1s\xb2\0\xb3\x3\x93\xb3\x3\x61\0\0\0\0\0\0\0\0\0\xb3\x42\x62\xb2q\xb3\x3\xb2\0\0\xb3\x2\xb2\x11\0\0\0\x11\0\x92\xb1\0\0\0\0\xa3\xb1\xb1\xb1\xb1\xb1\xb1\0\x11\x11\x12\x32\x11\0\0\xb3\x42\0\0\0\xa2\x82\x12R\x84RR2\x82\x83\x86\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\x80\xb3\x3\xb2\0\0\x82\x3\x11\x11\x11\x11\0\x82\x83\xb3\x11\x11\x11\x11\x11\0\0\x82\x92\0\x92\x82\x42R\x84R\0\0\0\xa3\x82\0\0\xb3\x3\x82\xb3s\0\0\0\0\0\0\0\0\0\0\xb3\x42\x62\x11\x11\x11\x3\xb2\0\0\0\xb1\xb3\x2\xb2\0\xb3r\xb2\0\0\0\0\0\0\x82\xb2\x10\0\0\0\0\xb3\x12\"R#c\xb2\0\xb3\x13\x85\x85\x86\x82\x92\x42RRRRb\x1\x82\x82\x86\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\xb3s\xb2\0\0\xa2\x13SSSc\0\x82\x92\xb3\"\"\"\"2\x11\x11\x2\xb2\0\0\xa2\x13#RR\0\0\0\x1\x83\x92\0\xb3\x3\x82\x82\x82\0\0\0\0\x11\x11\x11\x11\x93\0\x11\x42R\"\"\"3\xb2\0\0\x10\0\0\xb1\0\0\xb3\x3\xb2\0\0\0\0\x85\x86\x82\xb2q\0\0\0\0\xb3\x42R3\xb1\xb1\0\0\0\xb1\x82\x1\x82\x83\0\x13#RR\x84\x62\x92\0\xa2\x82\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\x93\0\xb1\0\0\0\0\xb1\xb1\xb1\xb1\xb1\0\xa2\0\xb3#####Sc\xb1\0\0\0\0\xb1\xb1\x13R\0\0\0\0\x82\0\0\xb3\x3\x82\x83\x92\0\0\0\0\"\"\"2\x82\x83\x43####3\xb2\0\0\02\x93\0\0\0\0\xb3s\xb2\0\0\0\0\xa2\x1\x82\x11\x11\x11\x11\0\0\xb3\x13\x33\xb1\0\xa3\0a\0\0\0\xa2\x82\x93\xf3\x12\x32\x42R#3\x2\0\0\x82\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\x82\x92\0\0\x10\0A\0\0\0\0\0\0\0\0\xb3\x93\x10\xd3\0\0\xa2\x82\0\0\0\0\0\0\0\x82\x42\0\0\0\x86\x82v\0\xb3\x3\0\xa2\x82v\0\0\0RRRb\0\x82\x82\0\xa3\x1\x82\xa2\0a\0\xa3\x62\x82\0\0\0\0\0\xb1\0\0\0\x93\xa3\x82\x83\x82\"\"\"2\xb2\0\0\xb1\xb1\0\0\x83\0\0\0\x86\0\0\x12\"\"Rb\x13\x33\x12\"2\x82\x93\x82v\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\x1v\x85\xa3\x12\"2\x11\x11\x11\x11\x11\0!\0\xb3\"\"2\x93\0\x1\x82\x93\0\0\0\0\x80\xa3\x1\x13\x10\0\xa3\x83\x82\x92\0\xb3s\0\0\x83\x92\0\0\0R\x84Rb\0\xa2\x82\x82\x82\x83\x92\0\0\0\0\x82\x62\x83\x93!\0\0\0\0\0\0\xa3\x82\x82\x82\x82\x1R\x84Rb\xb2\x61\0\0\x93\0\0\x82\xa3\0\xa3\x82\x10\0\x13RR\x84R\"\"RRR2\x1\x83\x82\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\x82\x83\x82\x82\x42RR\"\"\"\"2\0q\0\xb3RRb\x82\xa3\x82\x83\x82\0\0\0\0\0\x83\x82\x82\x32\0\x1\x82\x82\0\0\0\x83\0\0\x82\x1\0\0\0RRRbqq\x82\x83\x82\0\0\0\0\0\xa3\x82\x62\x82\x1r\x93\0\0\0\0\xa2\x82\x82\x83\x82\x82\x82RR\x84\x62\xb2\0\0\xa3\x83\0\xa3\x82\x1\x82\x83\x82\x12\"2BRRRRRR\x84RR\"\"2\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0";
static unsigned char tilemap[tilemap_length];
static unsigned char tile_flags[] = {
	00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,
	04,02,00,00,00,00,00,00,00,00,00,02,00,00,00,00,
	03,03,03,03,03,03,03,03,04,04,04,02,02,00,00,00,
	03,03,03,03,03,03,03,03,04,04,04,02,02,02,02,02,
	00,00,19,19,19,19,02,02,03,02,02,02,02,02,00,02,
	00,00,19,19,19,19,02,02,04,02,02,02,02,02,02,02,
	00,00,19,19,19,19,00,04,04,02,02,02,02,02,02,02,
	00,00,19,19,19,19,00,00,00,02,02,02,02,02,02,02
};

static ALLEGRO_FONT* font = NULL;

void InitEmu() {
	Celeste_P8_set_call_func(HandleP8Call);

	char* mapdata = "2331252548252532323232323300002425262425252631323232252628282824252525252525323328382828312525253232323233000000313232323232323232330000002432323233313232322525252525482525252525252526282824252548252525262828282824254825252526282828283132323225482525252525252331323232332900002829000000242526313232332828002824262a102824254825252526002a2828292810244825282828290000000028282900000000002810000000372829000000002a2831482525252525482525323232332828242525254825323338282a283132252548252628382828282a2a2831323232322525252523201028380000002a0000003d24252523201028292900282426003a382425252548253300002900002a0031252528382900003a676838280000000000003828393e003a2800000000000028002425253232323232332122222328282425252532332828282900002a283132252526282828282900002a282828382824483232332828282900000000003f2020244825262828290000002a243300002a2425322525260000000000000000003125290000000021222328280000000000002a2828343536290000000000002839242526212223202123313232332828242548262b000000000000001c00003b2425262828280000000000282828282824252340283828293a2839000000343522252548262900000000000030000000002433003125333d3f00000000000000003100001c3a3a31252620283900000000000010282828290000000011113a2828313233242526103133202828282838242525262b000000000000000000003b2425262a2828670016002a28283828282425263a282828102829000000000000312525323300000000110000370000003e2400000037212223000000000000000000395868282828242628290000000000002a2828290000000000002123283828292828313233282829002a002a2828242525332b0c00000011110000000c3b314826112810000000006828282828282425252235353628280000000000003a282426003d003a3900270000000000002125001a000024252611111111000000002c28382828283831332800000017170000002a000000001111000024261028290028281b1b1b282800000000002a2125482628390000003b34362b000000002824252328283a67003a28282829002a313225333828282900000000000000283824252320201029003039000000005824480000003a31323235353536675800003c282828281028212329000000000000000000000000003436003a2426282800003828390000002a29000000000031323226101000000000282839000000002a24253328282838002828283900000017002600002a28000000003a283a2828282425252223283900372858390068283132000000282828282820202828283921222829002a28282426000000000000000000000000000020382828312523000000282828290000000000163a67682828003338280b00000010382800000b00003133282828282868282828280000001700330000002867580000281028283422252525482628286720282828382828212200003a283828102900002a28382824252a0000002838242600000017170000000000000000002728282a283133390000282900000000000000002a28282829002a2839000000002a2829000000000000282828382828282828282900000000000000003a2828383e3a2828283828242548252526002a282729002a28283432250000002a282828000000002810282425000000002a282426000000000000000000000000000037280000002a28283900280000003928390000000000282800000028290000002a2828000000000000002a2828282810282828286758000000000000002838282821232800002a28242532322526003a2830000000002a28282400000000002a281111111128282824480000003a28283133000000000000171700013f0000002029000000003828000028013a28281028580000003a28290000002a280c0000003a380c00000000000c00002a2828282828292828290000003a00013a2123282a313329001111112425002831263a3829300000000000002a310000000000002834222236292a0024253e013a3828292a00000000000000000035353536000020000000003d2a28671422222328282828283900582838283d00003a290000000028280000000000000000002a28282a29000058100012002a2822222225262900212311112122222525002a3837282900301111110000003a2800013f0000002a282426290000002425222222232900000000000000171700002a282039003a2000003a003435353535252525222222232828282810282821220b10000000000b28100000000b0000002c00002838000000002a2839170000282548252526111124252222252525482500012a2828673f242222230000003828222223000012002a24260000001224252525252600000000171700000000000000382028392827080028676820282828254825252525262a28282122222225253a28013d0000006828390000000000003c0168282800171717003a2800003a2825252525252222252525252525252525222222222222222525482667586828282548260000270000242600000021252525254826171700000000000000000000002a2028102830003a282828202828282525252548252600002a2425252548252821222300000028282800000000000022222223286700000000282839002838253233000000243232323232323225252525262828282824253232323225482525323232323232322526282828244825252525330000000000000000000000522525323232323331323232323328290026282928670000000000282831323232252525323328280031252548252525482525482628382831323232323232254826282800000030402a282828282824252548262838282831333828290031322526280000163a28283133282838242525482526000000000000000000000000522526000016000000002a10282838390026281a3820393d000000002a3828282825252628282829003b24253232323232323232332828282828281028282031253328390000003700002a3828002a2425252526282828282028292a0000002a313328111111282828000028002a312525252526000000000000000000000000522526000000001111000000292a28290026283a2820102011111121222328281025252628382800003b24262b002a2a38282828282829002a280028283828283128281029000000000000282839002448252526282900282067000000000000003810212223283829003a1029002a242532323367000000000000000000004200252639000000212300000000002122222522222321222321222324482628282832323328282800003b31332b00000028102829000000000029002a28282829002828280016000000162a2828280024252525262700002a2029000000000000002834252533292a0000002a00111124252223282800002c46472c00000042535325262800003a242600001600002425252525482631323331323324252620283822222328292867000028290000000000283800111100001200000028292a1600283828000000000000003a28290024254825263700000029000000000000003a293b2426283900000000003b212225252526382867003c56573c4243435363633233283900282426111111111124252525482526201b1b1b1b1b24252628282825252600002a28143a2900000000000028293b212300001700001128670000002828286758000000586828380000313232323320000000000000000000272828003b2426290000000000003b312548252533282828392122222352535364000029002a28382831323535353522254825252525252300000000003132332810284825261111113435361111111100000000003b3133111111111127282900003b2828282810290000002a28286700002835353536111100000000000011302838003b3133000000000000002a28313225262a282810282425252662636400000000160028282829000000000031322525252525252667580000002000002a28282525323535352222222222353639000000003b34353535353536303800000017282900002a0000000000382a29003a282828283436200000000000002030282800002a29000011110000000028282831260029002a282448252523000000000039003a282900000000000000002831322525482526382900000017000058682832331028293b2448252526282828000000003b201b1b1b1b1b1b302800000017283a0000000000000000280000002828283810292a000000000000002a3710281111111111112136000000002a28380b2600000000212525252526001c0000002828281000000000001100002a382829252525252628000000001700002a212228282908003b242525482628282912000000001b00000000000030290000003b3829000000000000003a102900002838282828000000000000000000002a2828223535353535330000000000002828393300000000313225252533000000000028382829000000003b202b00682828003232323233290000000000000000312528280000003b3132322526382800170000000000000000110000370000000000290000000000000000002a000000282928292a0000000000000000000000282a332838282829000000000000001028280000000042434424252628390000000028002a0000110000001b002a2010292c1b1b1b1b0000000000000000000010312829160000001b1b1b313328106700000000001100003a2700001b000000000000000100000011111100000000002a3a2a0000000000000000000000002a2800282829002a000000000000000028282800000000525354244826282800000000290000003b202b39000000002900003c000000000000000000000000000028282800000000000000001b1b2a28290000010000273900383000000000000000001111201111112122230000001212002a00010000000000000000000000002900290000000000000000002a6768282900003f01005253542425262810673a3900013f0000002a3829001100000000002101000000000000003a67000000002a38286758680000010000000068280000002123003728292830000000000000000022222222222324482611111120201111002739000017170000001717000000000001000000001717000000282838393a0021222352535424253328282838290022232b00000828393b27000000001424230000001200000028290000000000282828102867001717171717282839000031333927101228370000000000000000254825252526242526212222222222223a303800000000000000000000000000001717000000000000003a28282828280024252652535424262828282828283925262b00003a28103b30000000212225260000002700003a2800000000000028283828282839000000586828382800002223383028172827000000000000000000000000000000008242525252528452339200001323232352232323232352230000000000000000b302000013232352526200a282834252522323232323232300000000000000a20182920013232352363636462535353545550000005525355284525262b2000000000000425252526282828242528452525284525252525200000000000085868242845252525252b1006100b1b1b1b103b1b1b1b1b103b100000000000000111102000000a282425233000000a213233300009200008392000000000000110000a2000000a28213000000002636363646550000005525355252528462b2a300000000004252845262828382132323232323232352528452000000000000a201821323525284525200000000000000007300000000007300000000000000b343536300410000011362b2000000000000000000000000a2000000000000b302b2002100000000a282000000000000000000560000005526365252522333b28292001111024252525262019200829200000000a282135252520000000000000000a2828242525252840000000000000000b10000000000b1000000000000000000b3435363930000b162273737373737373737374711000061000000110000b100b302b20000006182000000000000000000000000005600005252338282828201a31222225252525262820000a200111111000082834252520000000000000093a382824252525252000061000011000000000011000000001100000000000000000000020182001152222222222222222222222232b200000000b302b200000000b10000000000a200000000000000009300000000000000846282828283828282132323528452526292000000112434440000a28242528400000000000000a2828382428452525200000000b302b2936100b302b20061007293a30000000000000000b1a282931252845252525252232323232362b20000000000b10000001100000000000000000000000093000086820000a3000000005262828201a200a282829200132323236211111111243535450000b31252525200000000000000008282821323232323820000a300b1a382930000b100000000738283931100000000000011a382821323232323528462829200a20173b20061000000000000b302b2000061000000000000a385828286828282828293000000526283829200000000a20000000000005222222232263636460000b34252525200000011111111a3828201b1b1b1b1b182938282930082820000000000000000b100a282721100000000b372828283b12222223213233361000086920000000000100000000000b1000000000000000086938282828201920000a20182a37686526282829300000000000000000000005252845252328283920000b34284525200008612222232828382829300000000828282828283829200000000000061001100a382737200000000b373a2829211525284628382a2000000a2000000000000021111111111111111111111110061828282a28382820000000000828282825262829200000000000000000000000052525252526201a2000000b34252525200000113235252225353536300000000828300a282828201939300001100000072828292b1039300000000b100a282125223526292000000000000a3000000000043535353535353535353535363b2008282920082829200061600a3828382a284620000000000000000000000000000528452525262920000111111425252520000a28282132362b1b1b1b1000000009200000000a28282828293b372b2000073820100110382a30000001100828213621013336100000000000082930000000002828382828202828282828272b20083820000a282d3000717f38282920000526200000000000093000000000000005252525284620000b312223213528452000000828392b30300000000002100000000000000000082828282b303b20000b1a282837203820193000072a38292b16271000000000000930000838200000000b1a282820182b1a28283a28273b200828293000082122232122232820000a3233300000000000082920000000000002323232323330000b342525232135252000000a28200b37300000000a37200000010000000111111118283b373b200a300008282730392008283007382830011629300000000000082000082829200000000009261a28200008261008282000001920000000213233342846282243434000000000000000082000085860000008382829200000000b3425284523213230000100082000082000000a2820300002222321111125353630182829200008300009200b1030000a28200008282001262829200000000a3829200828200000000858600008282a3828293008292610082001000001222222252525232253535000000f3100000a3820000a2010000008292000000009300b3425252525222220400122232b200839321008683039300528452222262c000a28282820000a38210000000a3738000008293008292001362820000000000828300a3820100000000a282828292a2828283828282000000343434344442528452525252622535350000001263000083829300008200c1008210d3e300a38200b3425252528452521232425262b28682827282820103820052525252846200000082829200008282320000008382930000a28201820000b1628393000000008282008282829300000000008382000000a28201820000000035353535454252525252528462253535000000032444008282820000829300002222223201828393b342525252525252525252525262b2b1b1b1132323526200845223232323232352522323233382825252525252525252525284522333b2822323232323526282820000b34252525252845252525252848452525262838242528452522333828292425223232352520000000000000000000000000000000000000000000000000000000000000000525252845262b2000000b1b1b142620023338276000000824233b2a282018283525252845252232323235262b1b10083921000a382426283920000b3422323232323232323232323232323526201821352522333b1b1018241133383828242840000000000000000000000000000000000000000000000000000000000000000525252525262b20000000000a242627682828392000011a273b200a382729200525252525233b1b1b1b11333000000825353536382426282410000b30382a2a2a1829200a2828382820182426200a2835262b1b10000831232b2000080014252000000000000a300000000000000000000000000000000000000000000000000528452232333b20000001100824262928201a20000b3720092000000830300002323525262b200000000b3720000a382828283828242522232b200b373928000000100110092a2829211a2133300a3825262b2000000a21333b20000868242520000000000000100009300000000000000000000000000000000000000000000525262122232b200a37672b2a24262838292000000b30300000000a3820300002232132333b200000000b303829300a2838292019242845262b200000000000000a2b302b2a36182b302b200110000825262b200000000b1b10000a283a2425200000000a30082000083000000000000000000000094a4b4c4d4e4f400000000525262428462b200a28303b2214262928300000000b3030000000000a203e3415252222232b200000000b30392000000829200000042525262b2000000000000000000b100a2828200b100b302b211a25262b200000000000000000092b3428400000000827682000001009300000000000000000095a5b5c5d5e5f500000000232333132362b221008203b2711333008293858693b3031111111111114222225252845262b200001100b303b2000000821111111142528462b2000000000000000000000000110176851100b1b3026184621111111100000061000000b3135200000000828382670082768200000000000000000096a6b6c6d6e6f60000000082000000a203117200a203b200010193828283824353235353535353535252845252525262b200b37200b303b2000000824353535323235262b20000110000000000000000b30282828372b26100b100525232122232b200000000000000b14200000000a28282123282839200000000000000000097a7b7c7d7e7f7000000009200110000135362b2001353535353539200a2000001828282829200b34252522323232362b261b30300b3030000000092b1b1b1b1b1b34262b200b372b20000001100000000b1a2828273b200000000232333132333b200001111000000b342000000868382125252328293a30000000000000000000000000000000000000000b372b200a28303b2000000a28293b3000000000000a2828382827612525252b1b1b1b173b200b30393b30361000000000000000000b34262b271b303b20000b302b211000000110092b100000000a3b1b1b1b1b1b10011111232110000b342000000a28212528452523282838600000000000000000000000000000000000080b303b20000820311111111008283b311111111110000829200928242528452000000a3820000b30382b37300000000000000000000b3426211111103b2000000b1b302b200b372b200000000000082b21000000000b31222522363b200b313858586829242525252526201828286000000000000000000000000000000000000b373b20000a21353535363008292b32222222232111102b20000a21323525200000001839200b3038282820000000011111111930011425222222233b20000100000b10000b303b200000000858682b27100000000b3425233b1b1000000b182018283001323525284629200a28200000000000000000000000000000000009300b100000000b1b1b1b1b100a200b323232323235363b100000000b1b1135200000000820000b30382839200000000222222328283432323232333b2000000329300000000b373b200000000a20182111111110000b31333b100a30061000000a28293f3123242522333020000820000000000000000000000000000000000829200001000410000000000000000b39310d30000a28200000000000000824200000086827600b30300a282760000005252526200828200a30182a2006100a362820000000000b100000093a382838222222232b20000b1b1000083000000860000122222526213331222328293827600000000000000000000000000000000017685a31222321111111111002100b322223293000182930000000080a301131000a383829200b373000083920000005284526200a28282828392000000008262839321000000000000a3828282820152845262b261000093000082a300a3821000135252845222225252523201838200000000000000000000000000000000828382824252522222222232007100b352526282a38283820000000000838282320001828200000083000082010000005252526271718283820000000000a382628201729300000000a282828382828252528462b20000a38300a382018283821222324252525252525284525222223200000000000000000000000000000000";
	for (int i = 0, c = *mapdata; c; c = mapdata[i+=2]) {
		char s[] = {'0', 'x', mapdata[i], mapdata[i+1], 0};
		sscanf(s, "%hhx", &tilemap[i/2]);
	}

	memcpy(palette, base_palette, sizeof(palette));

	ALLEGRO_BITMAP* font_bmp = al_load_bitmap("assets/font.png");
	//load font from bitmap:  https://liballeg.org/a5docs/trunk/font.html#al_grab_font_from_bitmap
	int ranges[] = {
		'a', 'z', '0', '9',
		'~','~', '!','!', '@','@', '#','#', '$','$', '%','%', '^', '^', '&','&', '*','*', '(',')',
		'_','_', '+','+', '-','-', '=','=', '?','?', ':',':', '.','.', ' ',' '
	};
	font = al_grab_font_from_bitmap(font_bmp, (sizeof(ranges)/sizeof(*ranges))/2, ranges);
	al_destroy_bitmap(font_bmp);

	atlas = al_load_bitmap("assets/atlas.png"); //the graphics atlas
	strong_assert(atlas != NULL);
	for (int tx = 0; tx < al_get_bitmap_width(atlas)/8; tx++) {
		for (int ty = 0; ty < al_get_bitmap_height(atlas)/8; ty++) {
			int i = tx + ty*al_get_bitmap_width(atlas)/8;
			sprites[i] = al_create_sub_bitmap(atlas, tx*8, ty*8, 8, 8);
		}
	}
}

void DeinitEmu() {
	if (atlas) al_destroy_bitmap(atlas);
	if (font) al_destroy_font(font);
	for (int i = 0; i < sizeof(sprites)/sizeof(*sprites); i++)
		if (sprites[i]) al_destroy_bitmap(sprites[i]);
}

//input:
static int key_mappings[] = {
	ALLEGRO_KEY_LEFT, ALLEGRO_KEY_RIGHT, ALLEGRO_KEY_UP, ALLEGRO_KEY_DOWN,
	ALLEGRO_KEY_C, ALLEGRO_KEY_X
};
static unsigned char button_state = 0;
// k_left = 0;
// k_right = 1;
// k_up = 2;
// k_down = 3;
// k_jump = 4;
// k_dash = 5;

void InputEvKeyDown(int k) {
	for (int i = 0; i < sizeof(key_mappings)/sizeof(*key_mappings); i++) {
		if (k == key_mappings[i]) {
			button_state |= 1 << i;
		}
	}
}

void InputEvKeyUp(int k) {
	for (int i = 0; i < sizeof(key_mappings)/sizeof(*key_mappings); i++) {
		if (k == key_mappings[i]) {
			button_state &= ~(1 << i);
		}
	}
}

void EmuUpdate() {
	Celeste_P8_update();
}

void EmuDraw() {
	//draw normally
	Celeste_P8_draw();
	//now do the palette swap
	#if 0
	ALLEGRO_BITMAP* target = al_get_target_bitmap();
	al_lock_bitmap(target, ALLEGRO_PIXEL_FORMAT_ANY, ALLEGRO_LOCK_READWRITE);
	for (int x = 0; x < 128; x++) for (int y = 0; y < 128; y++) {
		for (int i = 0; i < sizeof(palette)/sizeof(*palette); i++) {
			ALLEGRO_COLOR pix = al_get_pixel(target, x, y);
			ALLEGRO_COLOR col = palette[i];
			float diff = (pix.r-col.r)*(pix.r-col.r) + (pix.g-col.g)*(pix.g-col.g) + (pix.b-col.b)*(pix.b-col.b);
			
			if (diff*diff < 1e-4) {
				al_put_pixel(x, y, palette[i]);
				goto next;

			}
		}
		next:;
	}
	al_unlock_bitmap(target);
	#endif
}

static int fget(int tile, int flag) {
	if (flag) flag--;
	return tile < sizeof(tile_flags)/sizeof(*tile_flags) && (tile_flags[tile] & (1 << flag)) != 0;
}

Celeste_P8_val HandleP8Call(CELESTE_P8_CALLBACK_TYPE t, ...) {
	va_list args;
	va_start(args, t);
	Celeste_P8_val ret;

	#define NEXT_INT() va_arg(args, int)
	#define NEXT_BOOL() va_arg(args, Celeste_P8_bool_t)
	#define NEXT_FLOAT() va_arg(args, double)
	#define RETI(x) do{ ret = (Celeste_P8_val){.i=x}; goto end; }while(0)
	#define RETF(x) do{ ret = (Celeste_P8_val){.f=x}; goto end; }while(0)
	#define OP(name, ...) case CELESTE_P8_##name: { __VA_ARGS__ } break;

	switch (t) {
		OP(RND,
			float max = NEXT_FLOAT(); 
			float v = max*((float)random() / (float)RAND_MAX);
			RETF(v);
		)
		OP(MUSIC,
			int index = NEXT_INT();
			int fade = NEXT_INT();
			int mask = NEXT_INT();
			//
		)
		OP(SPR,
			int sprite = NEXT_INT();
			float x = NEXT_FLOAT(), y = NEXT_FLOAT();
			int cols = NEXT_INT();
			int rows = NEXT_INT();
			bool flipx = NEXT_BOOL();
			bool flipy = NEXT_BOOL();

			int flag = (flipx ? ALLEGRO_FLIP_HORIZONTAL : 0) | (flipy ? ALLEGRO_FLIP_VERTICAL : 0);
			//al_draw_bitmap_region(atlas, 8*(sprite%128), 8*(sprite/128), 8*cols, 8*rows, x, y, flag);
			if (sprites[sprite]) al_draw_bitmap(sprites[sprite], x, y, flag);
		)
		OP(BTN,
			int b = NEXT_INT();

			RETI(button_state & (1<<b));
		)
		OP(SFX,
			int id = NEXT_INT();
		)
		OP(PAL,
			int a = NEXT_INT();
			int b = NEXT_INT();
			palette[a] = base_palette[b];
		)
		OP(PAL_RESET,
			memcpy(palette, base_palette, sizeof(palette));
		)
		OP(CIRCFILL,
			float x = NEXT_FLOAT(), y = NEXT_FLOAT();
			float r = NEXT_FLOAT();
			int c = NEXT_INT();
		)
		OP(PRINT,
			char* str = va_arg(args, char*);
			float x = NEXT_FLOAT(), y = NEXT_FLOAT();
			int c = NEXT_INT();

			al_draw_text(font, palette[c], x, y, 0, str);
		)
		OP(RECTFILL,
			float x = NEXT_FLOAT(), y = NEXT_FLOAT();
			float x2 = NEXT_FLOAT(), y2 = NEXT_FLOAT();
			int c = NEXT_INT();

			al_draw_filled_rectangle(x, y, x2, y2, palette[c]);
		)
		OP(LINE,
			float x = NEXT_FLOAT(), y = NEXT_FLOAT();
			float x2 = NEXT_FLOAT(), y2 = NEXT_FLOAT();
			int c = NEXT_INT();
		)
		OP(MGET,
			int tx = NEXT_INT(), ty = NEXT_INT();

			RETI(tilemap[tx + ty*128]);
		)
		OP(CAMERA,
			float x = NEXT_FLOAT(), y = NEXT_FLOAT();
		)
		OP(FGET,
			int tile = NEXT_INT(), flag = NEXT_INT();

			RETI(fget(tile, flag));
		)
		OP(MAP,
			int mx = NEXT_INT(), my = NEXT_INT();
			int tx = NEXT_INT(), ty = NEXT_INT();
			int mw = NEXT_INT(), mh = NEXT_INT();
			int mask = NEXT_INT();

			//draw map
			for (int x = 0; x < mw; x++) {
				for (int y = 0; y < mh; y++) {
					int tile = tilemap[x + mx + (y + my)*128];
					if (sprites[tile] && (mask == 0 || fget(tile, mask)))
						al_draw_bitmap(sprites[tile], tx+x*8, ty+y*8, 0);
				}
			}
		)
	}

	end:
	va_end(args);
	return ret;
}